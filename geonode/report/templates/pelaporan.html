{% extends 'template_utama.html' %}
{% load static %}
{% load bootstrap_filter %}

{% block content %}
<body onload="initMap()">

  <main id="main">
    
    <section id="contact" class="contact">
      <div class="container" data-aos="fade-up">
        <br><br><br>
        <header class="section-header">
            <p>Pelaporan</p>
        </header>
                
      <section id="pricing" class="pricing" >
        <div class="container border rounded p-4" style="background-color: #ffffff;">
          <header class="section-header">
            <h2>Apa saja yang bisa dilaporkan?</h2>
          </header>
          <div class="horizontal-line col-lg-1" style="border-bottom: 3px solid #a53232; margin: 20px auto;"></div>

          <div class="row gy-4" data-aos="fade-left">
            <div class="col-lg-4 col-md-6" data-aos="zoom-in" data-aos-delay="100">
              <div class="box border rounded p-4">
                <h3 style="color: #0b8074;"> Jalan Lingkungan </h3>
                  Jalan yang berada di lingkungan perumahan yang dalam kondisi rusak atau belum ditangani (masih tanah)
              </div>
            </div>

            <div class="col-lg-4 col-md-6" data-aos="zoom-in" data-aos-delay="300">
              <div class="box border rounded p-4">
                <h3 style="color: #e77e0e;">Drainase Lingkungan</h3>
                  Drainase yang berada di lingkungan perumahan yang belum ada atau dalam kondisi rusak.
              </div>
            </div>

            <div class="col-lg-4 col-md-6" data-aos="zoom-in" data-aos-delay="400">
              <div class="box border rounded p-4">
                <h3 style="color: #0e8d2a;">Rumah Tidak Layak Huni (RTLH)</h3>
                <div class="accordion accordion-flush" id="faqlist1">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq-content-1">
                        Rumah yang memenuhi indikator:
                      </button>
                    </h2>
                    <div id="faq-content-1" class="accordion-collapse collapse" data-bs-parent="#faqlist1">
                      <div class="accordion-body">
                        <ul>
                          <li>Tidak permanen/ rusak</li>
                          <li>Dinding dan atap dibuat dari bahan yang mudah rusak/lapuk, seperti papan, ilalang, bambu yang dianyam/gedeg, dan sebagainya</li>
                          <li>Dinding dan atap sudah rusak sehingga membahayakan, menganggu keselamatan penghuninya</li>
                          <li>Lantai tanah/ semen dalam kondisi rusak</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
      </section>
              
      <div class="container mt-5 border rounded p-4 " style="background-color: #ffffff;">
        <header class="section-header">
          <h2>Sampaikan Laporan Anda</h2>
        </header>
        <div class="horizontal-line col-lg-1" style="border-bottom: 3px solid #a53232; margin: 20px auto;"></div>

        <br>
        <div class="row gy-4">
            <div class="col-lg-12">
              <form method="post" enctype="multipart/form-data" action="{% url 'handle_form_lapor' %}" id="form-id">
                {% csrf_token %}
                <div class="form-row">
                  <div class="form-group box border " style="background-color: #c8eec0; padding: 10px;" >
                    <label for="agreement">
                      <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                      Harap inputkan data yang sebenarnya. Data yang Anda inputkan akan kami jaga kerahasiaannya sesuai dengan kebijakan privasi kami. Kami berkomitmen melindungi informasi pribadi Anda dan hanya menggunakannya untuk keperluan yang telah disetujui.
                      <br>
                    </label>
                    <i style="font-size: smaller;  color: #bb1b1b;"><b>*</b> : Harus diisi</i>
                  </div>
                  <div class="form-group col-md-6">
                      <label for="id_pelapor"><b>Nama Pelapor </b><b><i style="color: #bb1b1b;">*</i></b></label>
                      <input type="text" class="form-control" id="id_pelapor" name="pelapor" required>
                  </div>
                  <div class="form-group col-md-6">
                      <label for="id_nik"><b>NIK</b> <b><i style="color: #bb1b1b;">*</i></b></label>
                      <div class="error-message" id="nikError"></div>
                      <input type="text" class="form-control" id="id_nik" name="nik" pattern="\d{16}" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                      <label for="id_email"><b>Email</b> <i style="font-size: smaller; color: #858282;"> (Optional)</i></b></label>
                      <div></div>
                      <div class="error-message" id="emailError"></div>
                      <input type="email" class="form-control" id="id_email" name="email">
                  </div>
                  <div class="form-group col-md-6">
                    <label for="id_nohp"><b>No. Hp</b> <b><i style="color: #bb1b1b;">*</i></b></label>
                    <div class="error-message" id="nohpError"></div>
                    <input type="tel" class="form-control" id="id_nohp" name="nohp" pattern="^\+?\d{10,15}$" required>
                  </div>
                </div>
              
              
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label for="id_jenis_pelaporan"><b>Jenis Pelaporan</b> <b><i style="color: #bb1b1b;">*</i></b></label>
                        <select id="report-type" class="form-control" name="jenis_pelaporan" id="id_jenis_pelaporan" required>
                          <option value="" disabled selected>Pilih Jenis Pelaporan</option>
                          <option value="Jalan Lingkungan">Jalan Lingkungan</option>
                          <option value="Drainase Lingkungan">Drainase Lingkungan</option>
                          <option value="RTLH">Rumah Tidak Layak Huni (RTLH)</option>
                          <option value="etc">etc</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                  <label for="id_pesan"><b>Pesan Pelaporan</b> <b><i style="color: #bb1b1b;">*</i></b></label>
                  <textarea class="form-control" id="id_pesan" name="pesan" rows="5" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-10">
                      <label for="location-input"><b>Silakan masukkan alamat dan titik lokasi tempat kejadian</b>  <b><i style="color: #bb1b1b;">*</i></b></label>
                      <input type="text" id="location-input" class="form-control" name="lokasi" placeholder="Enter a location" required>
                      <input type="hidden" id="lat-input" name="latitude" required>
                      <input type="hidden" id="lng-input" name="longitude" required>
                      <div id="map"></div>
                    </div>
                    <div class="form-group col-md-2">
                      <p></p><br>
                      <button type="button" id="reset-button" class="btn btn-secondary">Reset Map</button>
                    </div>
                </div>
                <div class="form-group">
                </div>
                <div class="form-group">
                    <label for="id_foto"><b>Foto</b> <i>(maksimal 4)</i>  <b><i style="color: #bb1b1b;">*</i></b></label>
                    <input type="file" class="form-control" id="id_foto" name="foto" accept="image/*" multiple required>
                </div>
                <div id="preview" class="preview-grid" ></div>
                <br>
                <div class="form-group box border " style="background-color: #eec7c0; padding: 10px;" >
                  <label for="agreement">
                      <input type="checkbox" id="agreement" name="agreement" required>
                      Dengan ini saya menyatakan bahwa data dan informasi yang saya isi adalah benar dan saya bertanggung jawab penuh atas data dan informasi tersebut, serta bersedia data pribadi tersebut disimpan oleh DPRKP KOTA PADANG untuk digunakan sesuai peruntukannya.
                  </label>
                </div>
                <button type="submit" class="btn-lg btn-primary d-flex justify-content-end" style="margin: 20px auto;">Kirim</button>
              </form>                     
            </div>
        </div>
      </div>

    {% if messages %}
    <ul class="messages" style="display:none;">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <script>
        document.getElementById('form-id').addEventListener('input', function(event) {
            const target = event.target;

            if (target.id === 'id_nik') {
                const nikError = document.getElementById('nikError');
                if (!target.checkValidity()) {
                    nikError.textContent = '*NIK harus terdiri dari 16 digit angka.';
                } else {
                    nikError.textContent = '';
                }
            }

            if (target.id === 'id_nohp') {
                const nohpError = document.getElementById('nohpError');
                if (!target.checkValidity()) {
                    nohpError.textContent = '*Masukkan nomor HP yang valid.';
                } else {
                    nohpError.textContent = '';
                }
            }

            if (target.id === 'id_email') {
                const emailError = document.getElementById('emailError');
                if (!target.checkValidity()) {
                    emailError.textContent = '*Masukkan alamat email yang valid.';
                } else {
                    emailError.textContent = '';
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const messages = document.querySelectorAll('.messages li');
            messages.forEach(message => {
                if (message.classList.contains('success')) {
                    Swal.fire({
                        title: 'Success!',
                        text: message.textContent,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
        
        function initMap() {
            const initialLocation = { lat: -0.9033256158489008, lng: 100.38044418906239 };
            const map = new google.maps.Map(document.getElementById("map"), {
                center: initialLocation,
                zoom: 12,
            });
      
            const input = document.getElementById("location-input");
            const latInput = document.getElementById("lat-input");
            const lngInput = document.getElementById("lng-input");
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);
      
            const infowindow = new google.maps.InfoWindow();
            const marker = new google.maps.Marker({
                map: map,
                draggable: true,
                visible: false,
            });
      
            autocomplete.addListener("place_changed", () => {
                infowindow.close();
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }
      
                const location = place.geometry.location;
                map.setCenter(location);
                map.setZoom(17);
                marker.setPosition(location);
                marker.setVisible(true);
      
                latInput.value = location.lat();
                lngInput.value = location.lng();
      
                infowindow.setContent(place.name);
                infowindow.open(map, marker);
            });
      
            map.addListener("click", (event) => {
                placeMarker(event.latLng);
            });
      
            marker.addListener('dragend', (event) => {
                updateLatLng(event.latLng);
            });
      
            function placeMarker(location) {
                marker.setPosition(location);
                map.setCenter(location);
                marker.setVisible(true);
      
                updateLatLng(location);
      
                infowindow.setContent('Location: ' + location.lat() + ', ' + location.lng());
                infowindow.open(map, marker);
            }
      
            function updateLatLng(location) {
                latInput.value = location.lat();
                lngInput.value = location.lng();
            }
      
            document.getElementById("reset-button").addEventListener("click", () => {
                map.setCenter(initialLocation);
                map.setZoom(10);
                marker.setVisible(false);
                input.value = "";
                latInput.value = "";
                lngInput.value = "";
                infowindow.close();
            });
      
            // Handle form submission
            const form = document.getElementById("form-id");
            form.addEventListener("submit", function(event) {
                const fileInput = document.getElementById("id_foto");
                if (fileInput.files.length > 4) {
                    alert("Anda hanya dapat mengunggah maksimal 4 foto.");
                    event.preventDefault();
                }
            });

            document.getElementById('id_foto').addEventListener('change', function(event) {
              const preview = document.getElementById('preview');
              preview.innerHTML = ''; // Clear previous previews

              if (this.files.length > 4) {
                  alert('You can only upload a maximum of 4 files');
                  this.value = ''; // Clear the input
                  return;
              }

              Array.from(this.files).forEach(file => {
                  if (file.type.startsWith('image/')) {
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          const img = document.createElement('img');
                          img.src = e.target.result;
                          img.style.maxWidth = '150px'; // Set image preview size
                          img.style.margin = '10px';
                          preview.appendChild(img);
                      };
                      reader.readAsDataURL(file);
                  }
              });
          });

        }
      </script>
      

    </section>
  </main>

{% endblock %}
